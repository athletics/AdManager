/*!
 * AdManager - Generic code for GPT ad management
 *
 * @author Athletics - http://athleticsnyc.com
 * @see https://github.com/athletics/ad-manager
 * @version 0.3.1
 */

!function(e,t){"function"==typeof define&&define.amd?define("src/Util",["jquery"],t):"object"==typeof exports?module.exports=t(require("jquery")):(e.AdManager=e.AdManager||{},e.AdManager.Util=t(e.jQuery))}(this,function(e){function t(t,n){var i=[];return e.grep(t,function(t){-1===e.inArray(t,n)&&i.push(t)}),i}function n(t,n){return t=e.grep(t,function(e,t){return t!==n})}var i=function(){return"object"==typeof console&&console.log?Function.prototype.bind.call(console.log,console):void 0}();return{debug:i,difference:t,removeByKey:n}}),function(e,t){"function"==typeof define&&define.amd?define("src/Config",["jquery","./Util"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("./Util")):(e.AdManager=e.AdManager||{},e.AdManager.Config=t(e.jQuery,e.AdManager.Util))}(this,function(e,t){function n(t){s=e.extend(s,t)}function i(e,t){return r(s,e,t)}function o(e){if(e=e||!1,!e)return s;var t=e.indexOf("Selector",this.length-"Selector".length);return-1!==t?(e=e.slice(0,t)+"Class","."+a(s,e).replace(/^\./,"")):a(s,e)}function r(e,t,n){return"string"==typeof t&&(t=t.split(".")),t.length>1?r(e[t.shift()],t,n):e[t[0]]=n,e}function a(e,t){return"string"==typeof t&&(t=t.split(".")),t.length>1?a(e[t.shift()],t):t[0]in e?e[t[0]]:null}var d=!0,s=(d?t.debug:function(){},{account:null,adClass:"app_ad_unit",adUnitTargetClass:"app_unit_target",clientType:!1,context:"body",enabled:!0,insertExclusion:[],insertionEnabled:!1,insertion:{pxBetweenUnits:800,adHeightLimit:1e3,insertExclusion:["img","iframe","video","audio",".video",".audio",".app_ad_unit"]},inventory:[],pageConfigAttr:!1,targeting:[]});return{init:n,set:i,get:o}}),function(e,t){"function"==typeof define&&define.amd?define("src/Inventory",["jquery","./Util","./Config"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("./Util"),require("./Config")):(e.AdManager=e.AdManager||{},e.AdManager.Inventory=t(e.jQuery,e.AdManager.Util,e.AdManager.Config))}(this,function(e,t,n){function i(){return r(o(n.get("inventory")))}function o(e){for(var t=0;t<e.length;t++)"undefined"==typeof e[t].type&&(e[t].type="default");return e}function r(e){var n=window.innerWidth>0?window.innerWidth:screen.width;if(n>1024)return e;if(n>=768&&1024>=n)for(var i=980,o=0;o<e.length;o++){for(var r=[],a=0;a<e[o].sizes.length;a++)e[o].sizes[a][0]>i&&r.push(e[o].sizes[a]);e[o].sizes=t.difference(e[o].sizes,r)}return e}function a(){var t,o=[],r=n.get("clientType"),a=i();return e.each(a,function(e,n){"undefined"!=typeof n.dynamic&&n.dynamic===!0&&(r&&r!==n.type||(o.push(n),t=n.localContext))}),{dynamicItems:o,localContext:t}}function d(e){for(var t={},n=i(),o=0;o<n.length;o++)if(n[o].id===e||n[o].slot===e)return t=n[o],t.idName="undefined"==typeof t.useIterator||t.useIterator?t.id+"_"+t.iteration:t.id,t;return t}function s(t){var n=0;return e.each(t.sizes,function(e,t){0===n?n=t[1]:t[1]<n&&(n=t[1])}),n}function u(t){var n=0;return e.each(t.sizes,function(e,t){t[1]>n&&(n=t[1])}),n}function l(n,i){return e.each(n.sizes,function(e,o){return o[1]<=i?!0:void(n.sizes=t.removeByKey(n.sizes,e))}),n}function g(t){var n="default";return e.each(i(),function(e,i){return i.id!==t?!0:(n=i.type,!1)}),n}function f(e){for(var t=n.get("inventory"),i=0;i<t.length;i++)if(t[i].id===e||t[i].slot===e){t[i].iteration="undefined"==typeof t[i].iteration?0:t[i].iteration+1,n.set("inventory",t);break}}{var c=!0;c?t.debug:function(){}}return{getInventory:i,getAdInfo:d,getDynamicInventory:a,shortestAvailable:s,tallestAvailable:u,limitUnitHeight:l,getUnitType:g,incrementAdSlot:f}}),function(e,t){"function"==typeof define&&define.amd?define("src/Manager",["jquery","./Util","./Config","./Inventory"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("./Util"),require("./Config"),require("./Inventory")):(e.AdManager=e.AdManager||{},e.AdManager.Manager=t(e.jQuery,e.AdManager.Util,e.AdManager.Config,e.AdManager.Inventory))}(this,function(e,t,n,i){function o(){m()&&(C=i.getInventory(),U=n.get("account"),j=n.get("adSelector"),r(),d())}function r(){e(document).on("GPT:unitsInserted",function(e){x(A+": "+e.type)}).on("GPT:libraryLoaded",function(e){x(A+": "+e.type),a()}).on("GPT:slotsDefined",function(e){x(A+": "+e.type),h()})}function a(){e.event.trigger("GPT:initSequence"),u(),l(),g(),f(),c()}function d(){var e,t,n,i,o=!1;window.googletag=window.googletag||{},e=window.googletag,e.cmd=e.cmd||[],t=document.createElement("script"),t.async=!0,t.type="text/javascript",n="https:"==document.location.protocol,t.src=(n?"https:":"http:")+"//www.googletagservices.com/tag/js/gpt.js",t.addEventListener?t.addEventListener("load",s,!1):t.readyState&&(t.onreadystatechange=function(){o||(o=!0,s())}),i=document.getElementsByTagName("script")[0],i.parentNode.insertBefore(t,i)}function s(){googletag.cmd.push(function(){e.event.trigger("GPT:libraryLoaded")})}function u(){googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",function(e){p(e)})})}function l(){googletag.cmd.push(function(){googletag.pubads().collapseEmptyDivs(),googletag.pubads().enableSingleRequest(),googletag.pubads().disableInitialLoad()})}function g(){googletag.cmd.push(function(){var t=n.get("targeting");t.length&&e.each(t,function(e,t){googletag.pubads().setTargeting(e,t)})})}function f(){var t=n.get("clientType"),i=e(n.get("context")),o=null,r=j;t!==!1&&(r+='[data-client-type="'+t+'"]'),o=i.find(r),o.each(function(){var t=e(this).data("id");M.push(t)})}function c(){googletag.cmd.push(function(){for(var t,o,r=null,a=e(n.get("context")),d=0;d<M.length;d++)i.incrementAdSlot(M[d]),r=i.getAdInfo(M[d]),"undefined"!=typeof r.id&&(t=a.find(j+'[data-id="'+r.id+'"]'),o=e("<div />"),t.length<1||(o.addClass(n.get("adUnitTargetClass")),o.attr("id",r.idName),t.append(o),t.addClass("active"),q[d]=googletag.defineSlot("/"+U+"/"+r.slot,r.sizes,r.idName).addService(googletag.pubads())));googletag.enableServices(),e.event.trigger("GPT:slotsDefined")})}function h(){googletag.cmd.push(function(){googletag.pubads().refresh(q);for(var t=0;t<M.length;t++)currentPosition=i.getAdInfo(M[t]),e("#"+currentPosition.idName).length&&googletag.display(currentPosition.idName)})}function p(t){var n=t.slot.getAdUnitPath().replace("/"+U+"/",""),o=i.getAdInfo(n);e.event.trigger("GPT:adUnitRendered",{name:n,id:o.id,size:t.size,isEmpty:t.isEmpty,creativeId:t.creativeId,lineItemId:t.lineItemId,serviceName:t.serviceName})}function v(t){var n=null;return e.each(q,function(e,i){var o=i.getAdUnitPath().replace("/"+U+"/","");return o===t?(n=i,!1):void 0}),n}function y(e){googletag.cmd.push(function(){var t=i.getAdInfo(e),n=v(t.slot);googletag.pubads().refresh([n]),googletag.display(t.idName),q=i.removeDefinedSlot(q,t.slot)})}function m(){return n.get("enabled")}function b(e){var t=e.$context,n=e.removeContainer||!1;t.find(j).empty(),n&&t.find(j).remove()}var A="Manager",I=!0,x=I?t.debug:function(){},q=[],M=[],C=[],U=null,j="";return{init:o,isEnabled:m,displaySlot:y,initSequence:a,emptyAds:b}}),function(e,t){"function"==typeof define&&define.amd?define("src/Insertion",["jquery","./Util","./Config","./Inventory"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("./Util"),require("./Config"),require("./Inventory")):(e.AdManager=e.AdManager||{},e.AdManager.Insertion=t(e.jQuery,e.AdManager.Util,e.AdManager.Config,e.AdManager.Inventory))}(this,function(e,t,n,i){function o(){r()}function r(){e(document).on("GPT:initSequence",function(e){I(b+": "+e.type),d()})}function a(){x=e(n.get("context"))}function d(){var e=i.getDynamicInventory();return a(),C=C.length?C:e.dynamicItems,j=j?j:e.localContext,C.length?(q=x.find(j).first(),q.length&&(M=!0),M?void u():void s()):void s()}function s(){e.event.trigger("GPT:unitsInserted")}function u(){M&&(l(),c(),h()),s()}function l(){var t=q.children(),i=n.get("insertExclusion");t.each(function(n){var o=e(this),r=n>0?t.eq(n-1):!1,a=!0;e.each(i,function(e,t){return o.is(t)||o.find(t).length?(a=!1,!1):void 0}),r&&r.is("p")&&1===r.find("img").length&&(a=!1),o.attr("data-valid-location",a)})}function g(e){return e.data("valid-location")}function f(t,o){var r=o||!1,a=i.getUnitType(t),d=U?"odd":"even",s=e("<div />");return s.addClass(n.get("adClass")).attr("data-id",t).attr("data-client-type",a),r?s.addClass("disableFloat"):s.addClass("inContent").addClass(d),r||(U=!U),s}function c(){var e=p(),t=i.tallestAvailable(e),o=i.shortestAvailable(e),r=v({height:t,limit:n.get("insertion.adHeightLimit")}),a=null;r||(r=v({height:o,limit:n.get("insertion.adHeightLimit"),force:!0}),r.disableFloat||(e=i.limitUnitHeight(e,o))),a=f(e.id,r.disableFloat),r.$insertBefore.before(a)}function h(){e.each(C,function(e,t){var n=i.tallestAvailable(t),o=v({height:n}),r=null;return o?(r=f(t.id,o.disableFloat),void o.$insertBefore.before(r)):!1})}function p(){var n=!1;return e.each(C,function(e,i){return i.primary?(n=i,C=t.removeByKey(C,e),!1):void 0}),n||(n=C[0],C=t.removeByKey(C,0)),n}function v(t){t=t||{};var n=m(),i=new y({$nodes:n,force:t.force?t.force:!1,limit:t.limit?t.limit:!1,height:t.height});return n.length?(e.each(n,function(t,n){var o=i.verifyNode(t,e(n));return o?!1:o?void 0:!0}),i.locationFound?(i.markValidNodes(),i.setLastPosition(),{$insertBefore:i.$insertBefore,disableFloat:i.disableFloat}):!1):!1}function y(e){this.totalHeight=0,this.marginDifference=40,this.inserted=[],this.$insertBefore=null,this.disableFloat=!1,this.locationFound=!1,this.validHeight=0,this.exitLoop=!1,this.height=e.height,this.force=e.force,this.limit=e.limit,this.$nodes=e.$nodes,this.lastPosition=0,this.neededheight=e.height-this.marginDifference}function m(){var e=q.find(n.get("adSelector")).last(),t=null;return t=e.length?e.nextAll(q):q.children()}var b="Insertion",A=!0,I=A?t.debug:function(){},x=null,q=null,M=!1,C=[],U=!0,j=null;return y.prototype.setLastPosition=function(){this.lastPosition=this.$insertBefore.offset().top+this.neededheight},y.prototype.markValidNodes=function(){this.inserted.length&&e.each(this.inserted,function(t,n){e(n).data("valid-location",!1)})},y.prototype.verifyNode=function(e,t){var i=t.offset().top-this.lastPosition,o=t.outerHeight(),r=this.$nodes.length-1===e;return this.totalHeight+=o,this.force&&(this.totalHeight>=this.limit||r)?(this.$insertBefore=t,this.disableFloat=!0,this.locationFound=!0,this.exitLoop=!0):this.limit&&(this.totalHeight>=this.limit||r)?(this.locationFound=!1,this.exitLoop=!0):g(t)?(this.validHeight+=o,this.inserted.push(t),null===this.$insertBefore&&(this.$insertBefore=t),this.validHeight>=this.neededheight&&(!this.limit&&i<n.get("insertion.pxBetweenUnits")&&(this.validHeight=0,this.$insertBefore=null),this.locationFound=!0,this.exitLoop=!0)):(this.validHeight=0,this.$insertBefore=null,this.exitLoop=null),this.exitLoop},{init:o}}),function(e,t){if("function"==typeof define&&define.amd)define("src/Index",["./Util","./Config","./Inventory","./Manager","./Insertion"],t);else if("object"==typeof exports)module.exports=t(require("./Util"),require("./Config"),require("./Inventory"),require("./Manager"),require("./Insertion"));else{var n=e.AdManager;e.AdManager=t(n.Util,n.Config,n.Inventory,n.Manager,n.Insertion)}}(this,function(e,t,n,i,o){function r(n){if(n=n||!1,!n)throw new Error("Please provide a config.");debug=e.debug,t.init(n),o.init(),i.init()}var a=r.prototype;return a.Util=e,a.Config=t,a.Inventory=n,a.Manager=i,a.Insertion=o,r});